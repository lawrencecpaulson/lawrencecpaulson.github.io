---
layout: post
title:  "An Experiment: The Cauchy–Schwarz inequality"
usemathjax: true 
tags: examples, Isabelle, Cauchy–Schwarz inequality
---

The [Cauchy–Schwarz inequality](https://en.wikipedia.org/wiki/Cauchy–Schwarz_inequality) is a well-known fact about vector inner products. It comes in various forms that any mathematician is expected to recognise. 

### A successful search

During discussions with colleagues, the question came up: is Cauchy–Schwarz available in the Isabelle/HOL libraries? I got a quick answer, thanks to the [SErAPIS search engine](https://behemoth.cl.cam.ac.uk/search/index.php?cat=1). I typed the phrase into the "concept" box and immediately got several close hits. (It helps that the theorem names actually match!)

<pre class="source">
<span class="keyword1"><span class="command">lemma</span></span> Cauchy_Schwarz_ineq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>inner <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> inner <span class="free">x</span> <span class="free">x</span> <span class="main">*</span> inner <span class="free">y</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"inner <span class="free">x</span> <span class="free">y</span> <span class="main">/</span> inner <span class="free">y</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> inner <span class="main">(</span><span class="free">x</span> <span class="main">-</span> scaleR <span class="var">?r</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> scaleR <span class="var">?r</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> inner_ge_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inner <span class="free">x</span> <span class="free">x</span> <span class="main">-</span> inner <span class="free">y</span> <span class="free">x</span> <span class="main">*</span> <span class="var">?r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inner_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> inner <span class="free">x</span> <span class="free">x</span> <span class="main">-</span> <span class="main">(</span>inner <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> inner <span class="free">y</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square inner_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> inner <span class="free">x</span> <span class="free">x</span> <span class="main">-</span> <span class="main">(</span>inner <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> inner <span class="free">y</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>inner <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> inner <span class="free">y</span> <span class="free">y</span> <span class="main">≤</span> inner <span class="free">x</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_diff_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>inner <span class="free">x</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> inner <span class="free">x</span> <span class="free">x</span> <span class="main">*</span> inner <span class="free">y</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pos_divide_le_eq y<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
</pre>

This version is a close match to the [Wikipedia description](https://en.wikipedia.org/wiki/Cauchy–Schwarz_inequality) and to the abstract formulation, namely

$$ \mid\langle \mathbf{u},\mathbf{v} \rangle{\mid}^2 \le \langle \mathbf{u},\mathbf{u}\rangle \langle \mathbf{v},\mathbf{v}\rangle. $$

Unfortunately, this abstract version––for the Isabelle type class `real_inner` of real inner product spaces––is not easily related to the concrete version with explicit summations, which is what I wanted. Such special cases look quite different from the abstract version, and even Wikipedia enumerates them separately.
Googling around for a simple concrete proof took me to [Hölder's inequality](https://en.wikipedia.org/wiki/Hölder%27s_inequality), which follows from [Young's inequality for products](https://en.wikipedia.org/wiki/Young%27s_inequality_for_products), which holds "because the logarithm function is concave", which is a special case of [Jensen's inequality](https://en.wikipedia.org/wiki/Jensen%27s_inequality).
A rabbit hole of inequalities!

### Concave and convex functions

The following diagram ([borrowed from Wikipedia](https://commons.wikimedia.org/wiki/File:ConcaveDef.png)) shows what a concave function looks like.
 
![Diagram of concave function](/images/ConcaveDef.png)

And a concave function is the negation of a [convex function](https://en.wikipedia.org/wiki/Convex_function). Turning to SErAPIS again, I discovered that both concepts were defined in Isabelle's [Archive of Formal Proofs](https://www.isa-afp.org) (AFP). Moreover, convex functions were defined in the Isabelle libraries themselves, along with the key property that a function is convex if its second derivative is nonnegative. 

So by including the library session [HOL-Analysis](https://isabelle.in.tum.de/dist/library/HOL/HOL-Analysis/Inner_Product.html), concave functions are trivial to define:

<pre class="source">
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">concave_on</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>real_vector set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">concave_on</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> convex_on <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
</pre>

Their characteristic inequality follows by simply negating the inequality for convex functions:

<pre class="source">
<span class="keyword1"><span class="command">lemma</span></span> concave_on_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"concave_on <span class="free">S</span> <span class="free">f</span> <span class="main">⟷</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">u</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">v</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="bound">u</span> <span class="main">+</span> <span class="bound">v</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟶</span> <span class="free">f</span> <span class="main">(</span><span class="bound">u</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">v</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">y</span><span class="main">)</span> <span class="main">≥</span> <span class="bound">u</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">v</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> concave_on_def convex_on_def <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
</pre>

Recall that Young's inequality requires proving that the logarithm function is concave (on the positive reals). The Isabelle proof loois like this:

<pre class="source">
<span class="keyword1"><span class="command">lemma</span></span> ln_concave<span class="main">:</span> <span class="quoted"><span class="quoted">"concave_on <span class="main">{</span><span class="main">0</span><span class="main">&lt;..}</span> ln"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> concave_on_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> f''_ge0_imp_convex <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
</pre>

A little magic is happening here. After we unfold the definition of concave, the first step is to invoke the theorem `f''_ge0_imp_convex`, giving sufficient conditions for a function to be convex. There are four:

![Trying to prove that the ln is concave](/images/Concave_ln.png)

Let's express these formulas in plain language:

1. The set of positive real numbers (written as `{0<..}`) is a convex set. This will be proved automatically thanks to some library theorem about intervals.
2. The negation of the logarithm ($\lambda x. - {\ln x}$) has some derivative, written as `?f' x`. The question mark indicates a unifiable variable or unknown, which needs to be replaced by the actual derivative. It can depend upon `x`, which is a positive real.
3. The function `?f'` has some derivative, written as `?f'' x`. This is the second derivative.
4. This second derivative is nonnegative for all positive reals.

Proving these subgoals involves discovering the first derivative and then the second and finally proving the second to be nonnegative. One might imagine a lot of work to be necessary, but the magic line

<pre class="source">
   (<span class="operator">rule</span> <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
</pre>

is sufficient to calculate *and simplify* the derivative even of many complicated formulas.
Since the proof method `rule` can be given any number of lemmas or inference rules to try, we can throw in `f''_ge0_imp_convex` as well, yielding the two-line proof of `ln_concave` shown above. That result immediately allows us to prove one formulation of Young's inequality, $a^\alpha b^\beta \le \alpha a + \beta b$ where $\alpha+\beta=1$:

<pre class="source">
<span class="keyword1"><span class="command">lemma</span></span> Youngs_inequality_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">α</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">β</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span><span class="main">+</span><span class="free">β</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">&gt;</span><span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">&gt;</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">powr</span> <span class="free">α</span> <span class="main">*</span> <span class="free">b</span> <span class="keyword1">powr</span> <span class="free">β</span> <span class="main">≤</span> <span class="free">α</span><span class="main">*</span><span class="free">a</span> <span class="main">+</span> <span class="free">β</span><span class="main">*</span><span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">*</span> ln <span class="free">a</span> <span class="main">+</span> <span class="free">β</span> <span class="main">*</span> ln <span class="free">b</span> <span class="main">≤</span> ln <span class="main">(</span><span class="free">α</span> <span class="main">*</span> <span class="free">a</span> <span class="main">+</span> <span class="free">β</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms ln_concave <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> concave_on_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">α</span> <span class="main">*</span> <span class="free">a</span> <span class="main">+</span> <span class="free">β</span> <span class="main">*</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> <span class="main"><span class="main">(</span></span>verit<span class="main"><span class="main">)</span></span> mult_pos_pos split_mult_pos_le<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_def mult_exp_exp <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> ln_ge_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
</pre>

A more standard formulation, $ab\le a^p/p + b^q/q$ where $1/p+1/q=1$, holds by a suitable substitution into the previous result:

<pre class="source">
<span class="keyword1"><span class="command">lemma</span></span> Youngs_inequality<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">&gt;</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">&gt;</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="free">p</span> <span class="main">+</span> <span class="main">1</span><span class="main">/</span><span class="free">q</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">≥</span><span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">≥</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">a</span> <span class="keyword1">powr</span> <span class="free">p</span> <span class="main">/</span> <span class="free">p</span> <span class="main">+</span> <span class="free">b</span> <span class="keyword1">powr</span> <span class="free">q</span> <span class="main">/</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">=</span><span class="main">0</span> <span class="main">∨</span> <span class="free">b</span><span class="main">=</span><span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">using</span></span> Youngs_inequality_0 <span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">/</span><span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">powr</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="keyword1">powr</span> <span class="free">q</span>"</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> powr_powr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
</pre>

But having got this far, I felt rather lazy (it was a Saturday) and instead of trying to prove Hölder's inequality I asked what would happen if I took the proof about inner products at the top of this page and substituted the obvious summation over a fixed index set. And here is the result, with almost no effort:

<pre class="source">
<span class="keyword1"><span class="command">lemma</span></span> Cauchy_Schwarz_ineq_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>linordered_field"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">b</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="free">b</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="free">b</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span><span class="free">I</span> <span class="main">⟹</span> <span class="free">b</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"infinite <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> sum_pos2 zero_le_power2 zero_less_power2<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≡</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">b</span> <span class="bound">i</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="free">b</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> True <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">b</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="free">b</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span> <span class="bound">i</span> <span class="main">-</span> <span class="skolem">r</span> <span class="main">*</span> <span class="free">b</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> sum_nonneg zero_le_power2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">r</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">b</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">r</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="free">b</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> power2_eq_square sum_distrib_left <span class="quasi_keyword">flip</span><span class="main"><span class="main">:</span></span> sum.distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">b</span> <span class="bound">i</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">b</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="free">b</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_def power2_eq_square<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">b</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="free">b</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">b</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">/</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="free">b</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_diff_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">b</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="free">b</span> <span class="bound">i</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pos_divide_le_eq True<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
</pre>

That's the great thing about structured proofs: they can easily be modified to prove related results. There may well be a clever way to prove this fact from `Cauchy_Schwarz_ineq` by unfolding the function `inner`, which has multiple definitions (one for each instance of the `real_inner` type class). But sometimes, simplest is best.

*Note*: all of the material above is scheduled for inclusion in the next Isabelle release, planned for December 2021. It can also be downloaded [here](/Isabelle-Examples/CauchySchwarz).

### Exercises

It's worth practising the derivative trick mentioned above. Here I have introduced the dummy predicate `P` in order that the proof will fail, allowing you to see what derivative was computed. You should be able to guess the derivative of the last example without running it. Note the use of the rules `exI` and `conjI` to strip off the outer connectives.

<pre class="source">
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">^</span><span class="numeral">3</span> <span class="main">+</span> <span class="bound">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="keyword1">has_real_derivative</span> <span class="bound">f'</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">f'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI conjI <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
</pre>

<pre class="source">
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">f'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> ln <span class="bound">x</span><span class="main">)</span> <span class="keyword1">has_real_derivative</span> <span class="bound">f'</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">f'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI conjI <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
</pre>

<pre class="source">
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f'</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>sin <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span>cos <span class="bound">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span> <span class="keyword1">has_real_derivative</span> <span class="bound">f'</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">at</span> <span class="free">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">f'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> exI conjI <span class="dynamic"><span class="dynamic">derivative_eq_intros</span></span> <span class="main"><span class="keyword3">|</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
</pre>

If you have ever written code in Prolog to calculate symbolic derivatives, you'll understand what's going on here.

